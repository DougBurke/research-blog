<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"></meta>
        <title>Doug's research blog - Spectrum II</title>
        <link rel="stylesheet" type="text/css" href="../css/default.css"></link>
    </head>
    <body>
        <h1>Doug's research blog - Spectrum II</h1>
        <div id="navigation">
            <a href="../index.html">Home</a>
	    <a href="../intro.html">Introduction</a>
            <a href="../posts/">All posts</a>
	    <a href="../dictionary.html">Dictionary</a>
	    <a href="../acknowledge.html">Acknowledgements</a>
        </div>

	<div id="main">
        <div id="publisheddate">
<p>by <em>Douglas Burke</em> on <strong>31 October 2012</strong></p>
</div>

<div class="neighbours">
  <div class="previouspost"><a href="../posts/2012-10-30-waiting.html">Waiting</a><br /><span class="label">previous post</span></div>

</div>

<p>Let’s try a more-detailed analysis of the source spectrum than <a href="../posts/2012-10-26-spectrum.html">last time</a>.</p>
<p>We start by loading the data into Sherpa and plotting the un-grouped data, comparing it to he background level (we have to scale by the extraction areas for the comparison; this value is stored in the elegantly-named <code>BACKSCAL</code> variable):</p>
<pre><code>% sherpa
-----------------------------------------------------
Welcome to Sherpa: CXC's Modeling and Fitting Package
-----------------------------------------------------
CIAO 4.4 Sherpa version 2 Tuesday, June 5, 2012

sherpa-1&gt; load_data('group.pi')
read ARF file group.warf
read RMF file group.wrmf
read ARF (background) file group_bkg.warf
read RMF (background) file group_bkg.wrmf
read background file group_bkg.pi
sherpa-2&gt; get_data_plot_prefs()['linestyle'] = chips_solid
sherpa-3&gt; get_data_plot_prefs()['symbolstyle'] = chips_none
sherpa-4&gt; plot_data()
sherpa-5&gt; notice(0.5,7)
sherpa-6&gt; plot_data()
sherpa-7&gt; set_stat('cash')
sherpa-8&gt; plot_data()
WARNING: unable to calculate errors using current statistic: cash
sherpa-9&gt; bplot = get_bkg_plot()
WARNING: unable to calculate errors using current statistic: cash
sherpa-10&gt; norm = get_backscal() / get_backscal(bkg_id=1)
sherpa-11&gt; bx = bplot.x.copy()
sherpa-12&gt; by = bplot.y * norm
sherpa-13&gt; add_curve(bx, by, ['*.color', 'red', 'symbol.style', 'none'])
sherpa-14&gt; set_curve(['line.thickness', 2])
sherpa-15&gt; print_window('source-with-bgnd.png')</code></pre>
<div class="figure">
<img src="../images/source-with-bgnd.png" alt="The black line is the source and the red line the background level. The background signal is almost insignificant - earlier I estimated that there are \sim 5 background events in the 64 events in the source region - except that the background spectrum has a much-different shape to the source. The source emission is concentrated below \sim 2 keV, whereas the background signal extends across the whole energy range. This is important because we do not want the high-energy events biasing the source spectrum (making it try to account for these photons); one option would be to cut out this energy range from the fit, but we also want to use the lack of counts here as a constraint on the fit."></img><p class="caption">The black line is the source and the red line the background level. The background signal is almost insignificant - earlier I estimated that there are <span class="math"> ∼ 5</span> background events in the <span class="math">64</span> events in the source region - except that the background spectrum has a much-different shape to the source. The source emission is concentrated below <span class="math"> ∼ 2</span> keV, whereas the background signal extends across the whole energy range. This is important because we do not want the high-energy events biasing the source spectrum (making it try to account for these photons); one option would be to cut out this energy range from the fit, but we also want to use the lack of counts here as a constraint on the fit.</p>
</div>
<p>So now we try to fit the background; note that we have changed to the <a href="http://cxc.harvard.edu/sherpa/ahelp/cash.html">Cash statistic</a> since we are fitting low-count data (i.e. data for which we can assume a Poission rather than Gaussian distribution). I have chosen to use a <a href="http://cxc.harvard.edu/sherpa/ahelp/xsmekal.html">Mekal model</a> to account for emission from our own galaxy and a <a href="http://cxc.harvard.edu/sherpa/ahelp/powlaw1d.html">powerlaw model</a> for the other emission (that corresponds to un-resolved X-ray sources and particle background); both are <a href="http://cxc.harvard.edu/sherpa/ahelp/xsphabs.html">absorbed by gas in the galaxy</a> using the column density used previously:</p>
<pre><code>sherpa-16&gt; plot_bkg()
WARNING: unable to calculate errors using current statistic: cash
sherpa-17&gt; set_bkg_source(galabs.xphabs * (gal.mekal + powlaw1d.bgnd))
NameError: name 'galabs' is not defined
sherpa-18&gt; set_bkg_source(xphabs.galabs * (xsmekal.gal + powlaw1d.bgnd))
NameError: name 'xphabs' is not defined
sherpa-19&gt; set_bkg_source(xsphabs.galabs * (xsmekal.gal + powlaw1d.bgnd))
sherpa-20&gt; galabs.nh = 0.07
sherpa-21&gt; freeze(galabs)
sherpa-22&gt; print(get_bkg_source())
(xsphabs.galabs * (xsmekal.gal + powlaw1d.bgnd))
   Param        Type          Value          Min          Max      Units
   -----        ----          -----          ---          ---      -----
   galabs.nH    frozen         0.07            0       100000 10^22 atoms / cm^2
   gal.kT       thawed            1       0.0808         79.9        keV
   gal.nH       frozen            1        1e-05        1e+19       cm-3
   gal.Abundanc frozen            1            0         1000           
   gal.redshift frozen            0            0           10           
   gal.switch   frozen            1            0            1           
   gal.norm     thawed            1            0        1e+24           
   bgnd.gamma   thawed            1          -10           10           
   bgnd.ref     frozen            1 -3.40282e+38  3.40282e+38           
   bgnd.ampl    thawed            1            0  3.40282e+38           
sherpa-23&gt; set_method('simplex')
sherpa-24&gt; fit_bkg()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 3.72332e+07
Final fit statistic   = 532.495 at function evaluation 1147
Data points           = 446
Degrees of freedom    = 442
Change in statistic   = 3.72327e+07
   gal.kT         48.5024     
   gal.norm       0.000341969 
   bgnd.gamma     -4.61301    
   bgnd.ampl      6.99051e-09 
WARNING: parameter value bgnd.ampl is at its minimum boundary 0.0</code></pre>
<p>I have just realised that earlier I used the APEC rather than MEKAL model for modelling thermal plasmas; for this data set the difference between these two models should be small.</p>
<p>So, other than suffering several problems in trying to get the model set up, we can see that the fit is not very good (the local emission should have a temperature below <span class="math"> ∼ 0. 2</span> keV, and the power-law slope should be no-where near -5). I have decided to try re-fitting with just the power-law component (since I managed to get this to work earlier in the day):</p>
<pre><code>sherpa-25&gt; set_bkg_source(galabs * bgnd)
sherpa-26&gt; bgnd.gamma = 1
sherpa-27&gt; fit_bkg()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 15457.7
Final fit statistic   = 703.056 at function evaluation 310
Data points           = 446
Degrees of freedom    = 444
Change in statistic   = 14754.6
   bgnd.gamma     0.551107    
   bgnd.ampl      4.72044e-05 
sherpa-28&gt; fit_bkg()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 703.056
Final fit statistic   = 703.056 at function evaluation 290
Data points           = 446
Degrees of freedom    = 444
Change in statistic   = 1.13687e-13
   bgnd.gamma     0.551107    
   bgnd.ampl      4.72044e-05 
sherpa-29&gt; plot_fit_bkg()
NameError: name 'plot_fit_bkg' is not defined
sherpa-30&gt; plot_bkg_fit()
WARNING: unable to calculate errors using current statistic: cash
sherpa-31&gt; print_window('bgnd-powerlaw.png')
... on an OS-X machine you will see a lot of scary looking messages now
... that claim problems with the chipsServer such as kCGErrorIllegalArgument
... but these can be ignored</code></pre>
<div class="figure">
<img src="../images/bgnd-powerlaw.png" alt="The power law model is in at least the right ball park but it is hard to visualize whether it is a good fit given the data."></img><p class="caption">The power law model is in at least the right ball park but it is hard to visualize whether it is a good fit given the data.</p>
</div>
<p>I add back in the galaxy emission, tweak the starting temperature to be more realistic, and fit:</p>
<pre><code>sherpa-32&gt; set_bkg_source(galabs * (gal + bgnd))
sherpa-33&gt; gal.kt = 0.2
sherpa-34&gt; fit_bkg()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 946.365
Final fit statistic   = 500.503 at function evaluation 998
Data points           = 446
Degrees of freedom    = 442
Change in statistic   = 445.862
   gal.kT         0.195401    
   gal.norm       0.000100314 
   bgnd.gamma     -0.0255623  
   bgnd.ampl      2.2548e-05  
sherpa-35&gt; fit_bkg()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 500.503
Final fit statistic   = 500.503 at function evaluation 629
Data points           = 446
Degrees of freedom    = 442
Change in statistic   = 0
   gal.kT         0.195401    
   gal.norm       0.000100314 
   bgnd.gamma     -0.0255623  
   bgnd.ampl      2.2548e-05  
sherpa-36&gt; plot_bkg_fit()
WARNING: unable to calculate errors using current statistic: cash
sherpa-37&gt; set_curve('crv1', ['line.style', 'solid', 'symbol.style', 'none'])
sherpa-38&gt; print_window('bgnd-powerlaw-mekal.png')</code></pre>
<div class="figure">
<img src="../images/bgnd-powerlaw-mekal.png" alt="It is not obvious that the bump around 3 keV in the model is a good fit to the data, but it gives us something to go with."></img><p class="caption">It is not obvious that the “bump” around 3 keV in the model is a good fit to the data, but it gives us something to go with.</p>
</div>
<p>Now we have a model for the background we try to fit the source; note that, unlike last time, I have not used the <a href="http://cxc.harvard.edu/sherpa/ahelp/subtract.html">subtract command</a>, which means that <a href="http://cxc.harvard.edu/sherpa/ahelp/fit.html">the fit</a> we do will automatically include the background component, accounting for the difference in <code>BACKSCAL</code> value which I had to do manually in the first plot above.</p>
<pre><code>sherpa-39&gt; set_source(galabs * xsmekal.grp)
sherpa-40&gt; grp.redshift = 0.069
sherpa-41&gt; print(get_source())
(xsphabs.galabs * xsmekal.grp)
   Param        Type          Value          Min          Max      Units
   -----        ----          -----          ---          ---      -----
   galabs.nH    frozen         0.07            0       100000 10^22 atoms / cm^2
   grp.kT       thawed            1       0.0808         79.9        keV
   grp.nH       frozen            1        1e-05        1e+19       cm-3
   grp.Abundanc frozen            1            0         1000           
   grp.redshift frozen        0.069            0           10           
   grp.switch   frozen            1            0            1           
   grp.norm     thawed            1            0        1e+24           
sherpa-42&gt; fit()
Dataset               = 1
Method                = neldermead
Statistic             = cash
Initial fit statistic = 8.13847e+06
Final fit statistic   = 1746.56 at function evaluation 3182
Data points           = 892
Degrees of freedom    = 886
Change in statistic   = 8.13672e+06
   grp.kT         0.0808      
   grp.norm       0.000302551 
   gal.kT         0.193294    
   gal.norm       2.09033e-12 
   bgnd.gamma     1.56827     
   bgnd.ampl      0.00016626  
WARNING: parameter value grp.kT is at its minimum boundary 0.0808
WARNING: parameter value gal.norm is at its minimum boundary 0.0</code></pre>
<p>Oh. I didn’t expect this, namely</p>
<ul>
<li><p>the group temperature to be so low (as the warning message points out, this is the minimum temperature for which the XSMEKAL model is valid);</p></li>
<li><p>the galaxy emission (as represented by the <code>gal</code> component) is essentially 0 (in fact, all the background components have changed significantly from the background-only fit, which should not happen since the new data included in the fit should not influence the background values that much since the source area contributes hardly any “background” signal).</p></li>
</ul>
<p>If I call <code>plot_fit()</code> then the result is not a good fit to the data (since I am using the Cash statistic I can’t just use the statistic value as an indicator of the goodness of fit, unlike the chi-square variants in Sherpa).</p>
<p>Darn it. I had planned to leave with a fit where the group temperature was somewhere in the 1.5 to 2 keV range, as I had managed to get it earlier today when I was exploring the data. So, I’ve done something wrong and it’s not obvious what. Oh well, there’s always tomorrow.</p>
<p>Happy Halloween. I guess I’m showing you the gruesome side of Science, when things don’t go as planned and you run out of time (which, thinking about it, happens most days).</p>



<div class="neighbours">
  <div class="previouspost"><a href="../posts/2012-10-30-waiting.html">Waiting</a><br /><span class="label">previous post</span></div>

</div>

	</div>
	  
	<div id="disqus_thread"></div>
	<script type="text/javascript">
            var disqus_shortname = 'dougsresearchblog';
            (function() {
                var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
            })();
        </script>
	<!--
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        -->
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

	<div class="jumptostart">
	  <a href="#">Jump to top</a>
	</div>
	
	<div class="license">
	  All content © Douglas Burke 2012.<br>
	  <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.en_US"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by/3.0/88x31.png"></img></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/3.0/deed.en_US">Creative
	  Commons Attribution 3.0 Unported License</a>.
	</div>

    </body>
</html>
